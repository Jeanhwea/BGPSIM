# BGP 模拟器

-----------------------


1 简介
================

这是一个简单的BGP协议的模拟器，主要参照文档
[rfc1771](http://www.rfc-editor.org/rfc/rfc1771.txt "rfc1771")
来设计和实现。

2 报文格式
================

## 2.1 报文首部格式

每个BGP报文使用相同的首部， 其它的部分随着报文类型不同而变化，首部格式如下：

       0                   1                   2                   3
       0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
       +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
       |                                                               |
       +                                                               +
       |                                                               |
       +                                                               +
       |                           Marker                              |
       +                                                               +
       |                                                               |
       +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
       |          Length               |      Type     |
       +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+

## 2.2 OPEN报文格式

在TCP协议建立后，第一个发出的报文就是OPEN报文，如果OPEN报文被接受方接收到，
则接受方返回KEEPALIVE报文，用于确认OPEN报文发送成功。当OPEN报文发生被确认后，
UPDATE报文，KEEPALIVE报文和NOTIFICATION报文将可以进行交换。

除了BGP的首部，OPEN报文还应包含如下字段：

       0                   1                   2                   3
       0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
       +-+-+-+-+-+-+-+-+
       |    Version    |
       +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
       |     My Autonomous System      |
       +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
       |           Hold Time           |
       +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
       |                         BGP Identifier                        |
       +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
       | Opt Parm Len  |
       +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
       |                                                               |
       |                       Optional Parameters                     |
       |                                                               |
       +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+

## 2.3 UPDATE报文格式

UPDATE报文是用于传递BGP对等体之间的路由信息的。这些信息可以用于构建多个自治系统
之间关系图。通过应用规则来加以讨论，路由信息环路和一些其他的异常可以被检测并从自
治系统间路由除去。

除了BGP的首部，UPDATE报文还应包含如下字段：

       +-----------------------------------------------------+
       |   Unfeasible Routes Length (2 octets)               |
       +-----------------------------------------------------+
       |  Withdrawn Routes (variable)                        |
       +-----------------------------------------------------+
       |   Total Path Attribute Length (2 octets)            |
       +-----------------------------------------------------+
       |    Path Attributes (variable)                       |
       +-----------------------------------------------------+
       |   Network Layer Reachability Information (variable) |
       +-----------------------------------------------------+


## 2.4 KEEPALIVE报文格式

BGP不以任何传输协议为基础的保活机制确保对等体可达。相反，keepalive报文 
对等体之间不频繁地交换信息会引起HoldTimer过期。 KEEPALIVE报文之间合理
的最大时间被置为保持时间间隔的三分之一。

如果协商保持时间间隔是零，那么KEEPALIVE报文将不会被发送。

KEEPALIVE报文只包括BGP首部的19个字节。


## 2.5 NOTIFICATION报文格式


NOTIFICATION报文用于报告连接的错误。一旦发送NOTIFICATION报文过后，
就要立即断开BGP的链接。

除了BGP的首部，NOTIFICATION报文还应包含如下字段：

       0                   1                   2                   3
       0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
       +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
       | Error code    | Error subcode |           Data                |
       +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+                               +
       |                                                               |
       +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+


参考资料
======================

[1] : http://www.rfc-editor.org/rfc/rfc1771.txt "rfc1771"
